// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles
enum UserRole {
  USER
  ADMIN
  PROMPT_ADMIN  // Can edit all system prompts including sensitive ones
}

// NextAuth.js models
model User {
  id               String              @id @default(cuid())
  name             String?
  email            String?             @unique
  emailVerified    DateTime?
  image            String?
  role             UserRole            @default(USER)
  accounts         Account[]
  sessions         Session[]
  questionHistory  QuestionHistory[]
  chatSessions     ChatSession[]
  apiUsage         ApiUsage[]
  ownedProjects    BulkProject[]       @relation("ProjectOwner")
  ownedSkills      Skill[]             @relation("SkillOwner")
  ownedCustomers   CustomerProfile[]   @relation("CustomerOwner")
  ownedDocuments   KnowledgeDocument[] @relation("DocumentOwner")
  ownedUrls        ReferenceUrl[]      @relation("UrlOwner")
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model BulkProject {
  id             String   @id @default(uuid())
  name           String
  sheetName      String
  columns        String[] // Array of column names from spreadsheet
  createdAt      DateTime @default(now())
  lastModifiedAt DateTime @updatedAt
  ownerName      String?
  ownerId        String?  // Foreign key to User
  owner          User?    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  assignedUsers  Json?    // Array of user IDs who can access this project
  customerName   String?
  status         ProjectStatus @default(DRAFT)
  notes          String?

  // Review workflow fields
  reviewRequestedAt DateTime?
  reviewRequestedBy String?
  reviewedAt        DateTime?
  reviewedBy        String?

  rows              BulkRow[] // One-to-many relationship with BulkRow
  customerProfiles  ProjectCustomerProfile[] // Many-to-many with CustomerProfile

  @@index([status])
  @@index([lastModifiedAt])
  @@index([ownerId])
}

model BulkRow {
  id                   String   @id @default(uuid())
  projectId            String
  rowNumber            Int
  question             String   @db.Text
  response             String   @db.Text @default("")
  status               RowStatus @default(PENDING)
  error                String?  @db.Text
  conversationHistory  Json?    // Stored as JSON: { role: string; content: string }[]
  confidence           String?
  sources              String?  @db.Text
  reasoning            String?  @db.Text // What skills matched and what was found directly
  inference            String?  @db.Text // What was inferred/deduced, or "None" if everything was found directly
  remarks              String?  @db.Text
  usedSkills           Json?    // Stored as JSON: Skill[]
  showRecommendation   Boolean  @default(false)

  // Review flagging for individual questions
  flaggedForReview     Boolean  @default(false)
  flaggedAt            DateTime?
  flaggedBy            String?
  flagNote             String?  @db.Text

  project              BulkProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, rowNumber])
  @@index([projectId])
  @@index([status])
  @@index([flaggedForReview])
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  NEEDS_REVIEW
  APPROVED
}

enum RowStatus {
  PENDING
  COMPLETED
  ERROR
}

model KnowledgeDocument {
  id              String   @id @default(uuid())
  title           String
  filename        String
  fileType        String   // pdf, doc, docx, txt
  content         String   @db.Text // Extracted text content
  fileSize        Int      // bytes
  categories      String[] // Uses same categories as Skills
  uploadedAt      DateTime @default(now())
  description     String?  @db.Text
  isTemplate      Boolean  @default(false) // Whether this doc is a template
  templateContent String?  @db.Text // LLM-generated markdown template version
  ownerId         String?  // Foreign key to User
  owner           User?    @relation("DocumentOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  createdBy       String?  // User email for display

  @@index([uploadedAt])
  @@index([isTemplate])
  @@index([ownerId])
}

// Customer Profiles (The Rolodex)
model CustomerProfile {
  id              String   @id @default(uuid())
  name            String   // Company name
  industry        String?  // e.g., "Healthcare", "FinTech"
  website         String?  // Primary company URL
  overview        String   @db.Text // AI-generated company overview
  products        String?  @db.Text // Products/services description
  challenges      String?  @db.Text // Known challenges/pain points
  keyFacts        Json?    // Array of {label, value} pairs
  sourceUrls      Json?    // Array of {url, addedAt, lastFetchedAt}
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastRefreshedAt DateTime?
  createdBy       String?
  ownerId         String?  // Foreign key to User
  owner           User?    @relation("CustomerOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  owners          Json?    // Array of {name, email}
  history         Json?    // Audit trail entries

  projects        ProjectCustomerProfile[]

  @@index([isActive, updatedAt])
  @@index([industry])
  @@index([ownerId])
}

// Join table for Projects <-> CustomerProfiles (many-to-many)
model ProjectCustomerProfile {
  id        String   @id @default(uuid())
  projectId String
  profileId String
  addedAt   DateTime @default(now())

  project   BulkProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  profile   CustomerProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([projectId, profileId])
  @@index([projectId])
  @@index([profileId])
}

// Skills (Knowledge Gremlin)
model Skill {
  id              String   @id @default(uuid())
  title           String
  content         String   @db.Text
  categories      String[] // Broad capability areas
  quickFacts      Json?    // Array of {question, answer}
  edgeCases       String[]
  sourceUrls      Json?    // Array of {url, addedAt, lastFetchedAt}
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastRefreshedAt DateTime?
  createdBy       String?
  ownerId         String?  // Foreign key to User
  owner           User?    @relation("SkillOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  owners          Json?    // Array of {name, email} - legacy/additional owners
  history         Json?    // Audit trail entries

  @@index([isActive, updatedAt])
  @@index([ownerId])
}

// Skill Categories
model SkillCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  color       String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sortOrder])
}

// System Prompts (DEPRECATED - use PromptBlock instead)
model SystemPrompt {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "skill_builder", "chat", "customer_profile", "rfp_analysis"
  name      String   // Human-readable name
  sections  Json     // Array of {id, label, text, enabled, defaultText}
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

// Prompt Blocks - Reusable building blocks for composing prompts
model PromptBlock {
  id          String   @id @default(uuid())
  blockId     String   @unique // e.g., "role_mission", "output_format"
  name        String   // Human-readable name
  description String?  // What this block is for
  variants    Json     // { "default": "...", "questions": "...", "skills": "..." }
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([blockId])
}

// Prompt Modifiers - Runtime additions (mode, domain)
model PromptModifier {
  id        String   @id @default(uuid())
  modifierId String  @unique // e.g., "mode_single", "domain_technical"
  name      String   // Human-readable name
  type      String   // "mode" or "domain"
  content   String   // The prompt content
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([modifierId])
  @@index([type])
}

// Reference URLs (global URL store for knowledge building)
model ReferenceUrl {
  id          String   @id @default(uuid())
  url         String   @unique
  title       String?
  description String?
  categories  String[] // Uses same categories as Skills
  addedAt     DateTime @default(now())
  lastUsedAt  DateTime?
  usageCount  Int      @default(0)
  ownerId     String?  // Foreign key to User
  owner       User?    @relation("UrlOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  createdBy   String?  // User email for display

  @@index([addedAt])
  @@index([ownerId])
}

// Chat Prompts (prompt library for The Oracle)
model ChatPrompt {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  category    String   // e.g., "custom", "builtin", or custom category id
  description String?
  isBuiltin   Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  @@index([category])
  @@index([isBuiltin])
}

// Instruction Presets (persona/behavior instructions for chat)
model InstructionPreset {
  id               String                  @id @default(uuid())
  name             String
  content          String                  @db.Text // The instruction text
  description      String?                 // Brief description of what this preset is for
  isShared         Boolean                 @default(false) // If true, visible to all org users
  isDefault        Boolean                 @default(false) // If true, auto-selected for new chats
  shareStatus      InstructionShareStatus  @default(PRIVATE) // Approval workflow status
  shareRequestedAt DateTime?               // When share was requested
  approvedAt       DateTime?               // When approved
  approvedBy       String?                 // Admin who approved
  rejectedAt       DateTime?               // When rejected (if applicable)
  rejectedBy       String?                 // Admin who rejected
  rejectionReason  String?                 // Why it was rejected
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  createdBy        String?                 // User ID who created it
  createdByEmail   String?                 // For display

  @@index([isShared])
  @@index([shareStatus])
  @@index([createdBy])
}

enum InstructionShareStatus {
  PRIVATE           // Personal only, not shared
  PENDING_APPROVAL  // User requested to share, awaiting admin approval
  APPROVED          // Admin approved, now shared with org
  REJECTED          // Admin rejected the share request
}

// Context Snippets - Reusable boilerplate text for instructions
// e.g., company description, value props, certifications
model ContextSnippet {
  id          String   @id @default(uuid())
  name        String   // Human-readable name, e.g., "Company Description"
  key         String   @unique // Variable key, e.g., "company_description"
  content     String   @db.Text // The actual snippet text
  category    String?  // Optional grouping: "Company", "Product", "Compliance"
  description String?  // Brief description of what this snippet is for
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  // User email who created it

  @@index([category])
  @@index([isActive])
  @@index([key])
}

// Chat Prompt Categories
model ChatPromptCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  color       String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([sortOrder])
}

// Contract Reviews (The Clause Checker)
model ContractReview {
  id              String   @id @default(uuid())
  name            String   // Contract/document name
  filename        String   // Original filename
  fileType        String   // pdf, docx
  customerName    String?  // Who the contract is with
  contractType    String?  // e.g., "MSA", "DPA", "NDA", "SaaS Agreement"
  extractedText   String   @db.Text // Full extracted text
  status          ContractReviewStatus @default(PENDING)
  overallRating   String?  // "compliant", "mostly_compliant", "needs_review", "high_risk"
  summary         String?  @db.Text // AI-generated executive summary
  findings        Json?    // Array of ContractFinding objects
  skillsUsed      Json?    // Array of skill IDs used for analysis
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  analyzedAt      DateTime?
  reviewedAt      DateTime?
  reviewedBy      String?
  notes           String?  @db.Text

  @@index([status])
  @@index([createdAt])
  @@index([customerName])
}

enum ContractReviewStatus {
  PENDING      // Uploaded, not yet analyzed
  ANALYZING    // Analysis in progress
  ANALYZED     // Analysis complete, awaiting review
  REVIEWED     // Human reviewed
  ARCHIVED     // No longer active
}

// Question History - tracks quick questions from the home page
model QuestionHistory {
  id              String   @id @default(uuid())
  userId          String?  // Optional - null for anonymous users
  userEmail       String?  // For display purposes
  question        String   @db.Text
  response        String   @db.Text
  confidence      String?
  sources         String?  @db.Text
  reasoning       String?  @db.Text
  inference       String?  @db.Text
  remarks         String?  @db.Text
  skillsUsed      Json?    // Array of {id, title}
  createdAt       DateTime @default(now())

  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([createdAt])
}

// Chat Session - tracks full chat conversations in The Oracle
model ChatSession {
  id              String   @id @default(uuid())
  userId          String?  // Optional - null for anonymous users
  userEmail       String?  // For display purposes
  title           String?  // Auto-generated or user-editable title
  messages        Json     // Array of {id, role, content, timestamp, skillsUsed?, documentsUsed?, urlsUsed?, customersUsed?}
  skillsUsed      Json?    // Skills selected for this session
  documentsUsed   Json?    // Documents selected
  customersUsed   Json?    // Customer profiles selected
  urlsUsed        Json?    // Reference URLs selected
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, updatedAt])
  @@index([createdAt])
}

// API Usage Tracking - logs token usage and costs per API call
model ApiUsage {
  id              String   @id @default(uuid())
  userId          String?  // Optional - null for anonymous users
  userEmail       String?  // For display purposes
  feature         String   // e.g., "questions", "chat", "skills-suggest", "projects"
  model           String   // e.g., "claude-sonnet-4-20250514"
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  estimatedCost   Float    // Calculated cost in USD
  metadata        Json?    // Additional context (e.g., skill count, question length)
  createdAt       DateTime @default(now())

  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([feature, createdAt])
  @@index([createdAt])
}

// App Settings - key-value store for admin-configurable settings
// NOTE: Security engineer should implement encryption for sensitive values
model AppSetting {
  key         String   @id // e.g., "SALESFORCE_CLIENT_ID"
  value       String   @db.Text // The setting value (TODO: encrypt sensitive values)
  description String?  // Human-readable description
  isSecret    Boolean  @default(false) // Whether this is a sensitive value
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // Email of user who last updated
}

// Audit Log - tracks all changes across entities
model AuditLog {
  id            String         @id @default(uuid())
  entityType    AuditEntityType // skill, customer, project, document, etc.
  entityId      String         // ID of the affected entity
  entityTitle   String?        // Human-readable title/name of the entity
  action        AuditAction    // created, updated, deleted, etc.
  userId        String?        // User who performed the action
  userEmail     String?        // For display purposes
  userName      String?        // For display purposes
  changes       Json?          // Detailed changes: {field: {from, to}}
  metadata      Json?          // Additional context
  ipAddress     String?        // IP address if available
  userAgent     String?        // Browser/client info
  createdAt     DateTime       @default(now())

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([entityType, createdAt])
  @@index([createdAt])
}

enum AuditEntityType {
  SKILL
  CUSTOMER
  PROJECT
  DOCUMENT
  REFERENCE_URL
  CONTRACT
  USER
  SETTING
  PROMPT
  CONTEXT_SNIPPET
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  VIEWED
  EXPORTED
  OWNER_ADDED
  OWNER_REMOVED
  STATUS_CHANGED
  REFRESHED
  MERGED
}

